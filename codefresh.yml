version: '1.0'
steps:
  BuildingDockerImage:
    title: Building Docker Image
    type: build
    image_name: kubecon18/eshopweb
    working_directory: ./
    dockerfile: Dockerfile
    tag: '${{CF_BRANCH_TAG_NORMALIZED}}-${{CF_SHORT_REVISION}}'
  PushingDockerImage:
    title: Promote to Azure Container Registry
    type: push
    candidate: ${{BuildingDockerImage}}
    image_name: kubecon18/eshopweb
    tag: '${{CF_BRANCH_TAG_NORMALIZED}}-${{CF_SHORT_REVISION}}'
    registry: acrjdk8s
  PackageHelmChart:
      image: devth/helm
      commands:
        - cf_export PACKAGE=$(helm package .charts/eShopOnWeb | cut -d " " -f 8)
  Deploy_with_Helm:
    image: codefresh/cfstep-helm:2.11.0
    when:
      branch:
        only:
          - patricklang/k8s-win
    environment:
      - custom_commit_sha=${{CF_SHORT_REVISION}}
      - custom_image_repository=jdk8s.azurecr.io/kubecon18/eshopweb
      - custom_image_tag=${{CF_BRANCH_TAG_NORMALIZED}}-${{CF_SHORT_REVISION}}
      - custom_basedomain=${{INGRESS_HOSTNAME}}
    on_success:
      metadata:
        set:
          - '${{BuildingDockerImage.imageId}}':
            - DEPLOYED_TO_AZURE_AKS: true
